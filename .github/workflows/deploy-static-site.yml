name: Deploy Static Site to Azure Storage

on:
  push:
    branches: [main, dev]
    paths:
      - 'apps/web/**'
      - '.github/workflows/deploy-static-site.yml'
  workflow_dispatch: # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build Next.js app
        working-directory: apps/web
        env:
          NEXT_PUBLIC_API_BASE: https://layofflens-func.azurewebsites.net/api
        run: pnpm build
      
      - name: Verify build output
        run: |
          echo "Checking for build output..."
          ls -la apps/web/out || echo "out directory not found"
          ls -la apps/web/.next/out || echo ".next/out directory not found"
      
      - name: Configure Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Upload to Azure Storage
        run: |
          # Next.js static export creates 'out' directory (not .next/out)
          if [ -d "apps/web/out" ]; then
            echo "Uploading from apps/web/out"
            az storage blob upload-batch \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
              --source apps/web/out \
              --destination '$web' \
              --overwrite \
              --auth-mode key \
              --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}"
          else
            echo "Error: apps/web/out directory not found after build"
            exit 1
          fi
      
      - name: Invalidate CDN (if configured)
        run: |
          # If you have Azure CDN, uncomment and configure:
          # az cdn endpoint purge \
          #   --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          #   --profile-name <your-cdn-profile> \
          #   --name <your-cdn-endpoint> \
          #   --content-paths "/*"
        continue-on-error: true

